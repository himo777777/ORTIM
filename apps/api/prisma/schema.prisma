// ORTAC Database Schema
// Orthopaedic Resuscitation and Trauma Acute Care
// PostgreSQL with Prisma ORM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ANVÄNDARE OCH ROLLER
// ============================================

enum UserRole {
  PARTICIPANT
  INSTRUCTOR
  ADMIN
}

model User {
  id           String    @id @default(cuid())
  personnummer String    @unique
  firstName    String
  lastName     String
  email        String?   @unique
  phone        String?
  role         UserRole  @default(PARTICIPANT)
  workplace    String?
  speciality   String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lastLoginAt  DateTime?

  // Gamification fields
  totalXP         Int       @default(0)
  level           Int       @default(1)
  currentStreak   Int       @default(0)
  longestStreak   Int       @default(0)
  lastActivityAt  DateTime?
  weeklyXP        Int       @default(0)
  monthlyXP       Int       @default(0)
  weekStartedAt   DateTime?
  monthStartedAt  DateTime?

  // Relations
  enrollments              Enrollment[]
  quizAttempts             QuizAttempt[]
  chapterProgress          ChapterProgress[]
  certificates             Certificate[]
  instructorCohorts        Cohort[]           @relation("CohortInstructor")
  osceAssessments          OSCEAssessment[]   @relation("AssessedBy")
  lipusEvaluations         LipusEvaluation[]
  reviewCards              SpacedRepetitionCard[]
  pushSubscriptions        PushSubscription[]
  notifications            Notification[]
  passwordResetTokens      PasswordResetToken[]
  badges                   UserBadge[]
  organizationMemberships  OrganizationMember[]
  uploadedMedia            MediaAsset[]
  chatConversations        ChatConversation[]
  learningProfile          UserLearningProfile?

  // Fas 11: Avancerad Analytics
  sessions                 UserSession[]
  savedReports             SavedReport[]
  predictions              UserPrediction[]

  @@index([personnummer])
  @@index([email])
  @@index([totalXP])
}

// ============================================
// KURSSTRUKTUR
// ============================================

model Course {
  id              String    @id @default(cuid())
  code            String    @unique
  name            String
  fullName        String
  version         String
  lipusNumber     String?
  lipusValidUntil DateTime?
  description     String?   @db.Text
  estimatedHours  Int       @default(16)
  passingScore    Int       @default(70)
  isActive        Boolean   @default(true)
  instructorOnly  Boolean   @default(false)  // Endast för instruktörer/admin
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  parts        CoursePart[]
  cohorts      Cohort[]
  examCriteria CourseExamCriteria?
  certTemplate CertificateTemplate?

  @@index([code])
}

// Examinationskriterier för kursen
model CourseExamCriteria {
  id                    String   @id @default(cuid())
  courseId              String   @unique
  course                Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  // Quiz/Posttest kriterier
  quizPassingScore      Int      @default(70)     // Procent för godkänt
  quizRetakeAllowed     Int      @default(2)      // Max antal omtentering
  quizRetakeWaitDays    Int      @default(7)      // Väntedagar mellan försök

  // OSCE kriterier
  osceMinStationsPassed Int      @default(6)      // Minsta antal godkända stationer
  osceTotalStations     Int      @default(8)      // Totalt antal stationer
  osceAllowRetake       Boolean  @default(true)
  osceRetakeWaitDays    Int      @default(14)

  // EPA kriterier
  epaMinEntrustment     Int      @default(3)      // Minsta entrustment-nivå (1-5)
  epaAllRequired        Boolean  @default(true)   // Alla 12 EPA måste nås

  // Kritiska fel
  criticalErrorPolicy   String   @default("AUTO_FAIL") // AUTO_FAIL, REVIEW, WARNING

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([courseId])
}

model CoursePart {
  id          String  @id @default(cuid())
  courseId    String
  course      Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  partNumber  Int
  title       String
  description String?
  sortOrder   Int

  chapters Chapter[]

  @@unique([courseId, partNumber])
  @@index([courseId])
}

model Chapter {
  id              String   @id @default(cuid())
  partId          String
  part            CoursePart @relation(fields: [partId], references: [id], onDelete: Cascade)
  chapterNumber   Int
  title           String
  slug            String   @unique
  content         String   @db.Text
  contentVersion  Int      @default(1)
  estimatedMinutes Int     @default(30)
  sortOrder       Int
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  learningObjectives LearningObjective[]
  quizQuestions      QuizQuestion[]
  algorithms         Algorithm[]
  progress           ChapterProgress[]

  @@unique([partId, chapterNumber])
  @@index([slug])
}

model LearningObjective {
  id          String  @id @default(cuid())
  chapterId   String
  chapter     Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  code        String
  type        String
  description String
  sortOrder   Int

  @@index([chapterId])
}

model Algorithm {
  id          String   @id @default(cuid())
  chapterId   String?
  chapter     Chapter? @relation(fields: [chapterId], references: [id], onDelete: SetNull)
  code        String   @unique
  title       String
  description String?
  svgContent  String   @db.Text
  version     Int      @default(1)
  isActive    Boolean  @default(true)

  @@index([code])
}

// ============================================
// QUIZ OCH EXAMINATION
// ============================================

enum BloomLevel {
  KNOWLEDGE
  COMPREHENSION
  APPLICATION
  ANALYSIS
  SYNTHESIS
}

model QuizQuestion {
  id             String     @id @default(cuid())
  chapterId      String?
  chapter        Chapter?   @relation(fields: [chapterId], references: [id], onDelete: SetNull)
  questionCode   String     @unique
  bloomLevel     BloomLevel
  questionText   String     @db.Text
  explanation    String     @db.Text
  reference      String?
  isActive       Boolean    @default(true)
  isExamQuestion Boolean    @default(true)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  // Relations
  options          QuizOption[]
  attempts         QuizAttemptAnswer[]
  spacedRepetition SpacedRepetitionCard[]

  @@index([chapterId])
  @@index([bloomLevel])
}

model QuizOption {
  id          String       @id @default(cuid())
  questionId  String
  question    QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  optionLabel String
  optionText  String       @db.Text
  isCorrect   Boolean      @default(false)
  sortOrder   Int

  @@index([questionId])
}

model QuizAttempt {
  id             String    @id @default(cuid())
  userId         String
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  type           String
  chapterId      String?
  cohortId       String?
  totalQuestions Int
  correctAnswers Int
  score          Float
  passed         Boolean?
  startedAt      DateTime  @default(now())
  completedAt    DateTime?
  timeSpentSeconds Int?
  syncedAt       DateTime?

  // Relations
  answers QuizAttemptAnswer[]

  @@index([userId])
  @@index([type])
}

model QuizAttemptAnswer {
  id               String       @id @default(cuid())
  attemptId        String
  attempt          QuizAttempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  questionId       String
  question         QuizQuestion @relation(fields: [questionId], references: [id])
  selectedOption   String?
  isCorrect        Boolean
  timeSpentSeconds Int?

  @@index([attemptId])
  @@index([questionId])
}

// ============================================
// SPACED REPETITION
// ============================================

model SpacedRepetitionCard {
  id             String       @id @default(cuid())
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  questionId     String
  question       QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  easeFactor     Float        @default(2.5)
  interval       Int          @default(1)
  repetitions    Int          @default(0)
  nextReviewAt   DateTime     @default(now())
  lastReviewedAt DateTime?

  @@unique([userId, questionId])
  @@index([userId, nextReviewAt])
}

// ============================================
// PROGRESSION OCH CERTIFIERING
// ============================================

model ChapterProgress {
  id             String    @id @default(cuid())
  userId         String
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  chapterId      String
  chapter        Chapter   @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  startedAt      DateTime  @default(now())
  completedAt    DateTime?
  lastAccessedAt DateTime  @default(now())
  readProgress   Float     @default(0)
  quizPassed     Boolean   @default(false)
  bestQuizScore  Float?

  @@unique([userId, chapterId])
  @@index([userId])
}

model Cohort {
  id              String    @id @default(cuid())
  courseId        String
  course          Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  instructorId    String
  instructor      User      @relation("CohortInstructor", fields: [instructorId], references: [id])
  name            String
  description     String?
  startDate       DateTime
  endDate         DateTime?
  maxParticipants Int?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())

  // Relations
  enrollments      Enrollment[]
  lipusEvaluations LipusEvaluation[]

  @@index([courseId])
  @@index([instructorId])
}

model Enrollment {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  cohortId    String
  cohort      Cohort    @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  enrolledAt  DateTime  @default(now())
  status      String    @default("active")
  completedAt DateTime?

  // Relations
  osceAssessments OSCEAssessment[]

  @@unique([userId, cohortId])
  @@index([cohortId])
}

model OSCEAssessment {
  id               String     @id @default(cuid())
  enrollmentId     String
  enrollment       Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  assessorId       String
  assessor         User       @relation("AssessedBy", fields: [assessorId], references: [id])
  stationNumber    Int
  stationName      String
  passed           Boolean
  score            Float?
  comments         String?    @db.Text
  assessedAt       DateTime   @default(now())

  // Kritiska fel och detaljerad bedömning
  criticalErrors   String[]              // Lista över kritiska fel som begicks
  hasCriticalError Boolean   @default(false)
  checklistItems   Json?                 // Detaljerad checklista-bedömning

  @@index([enrollmentId])
}

model Certificate {
  id                  String   @id @default(cuid())
  certificateNumber   String   @unique
  userId              String
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  cohortId            String?
  courseCode          String
  courseName          String
  issuedAt            DateTime @default(now())
  validUntil          DateTime
  examScore           Float
  examPassed          Boolean
  oscePassed          Boolean?
  lipusNumber         String?
  verificationUrl     String   @unique
  pdfUrl              String?

  // Utökade fält för detaljerade resultat
  osceScore           Float?            // Genomsnittlig OSCE-poäng
  osceStationsPassed  Int?              // Antal godkända stationer
  epaAverageLevel     Float?            // Genomsnittlig EPA-entrustment
  epaAllPassed        Boolean?          // Alla EPA godkända

  // Recertifikation
  isRecertification    Boolean  @default(false)
  previousCertId       String?           // Tidigare certifikat-ID vid recertifikation
  recertificationCount Int      @default(0)

  @@index([userId])
  @@index([certificateNumber])
  @@index([verificationUrl])
}

// Certifikatmall för kursen
model CertificateTemplate {
  id                  String    @id @default(cuid())
  courseId            String    @unique
  course              Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)

  // Mall-information
  title               String    @default("ORTAC Certifikat")
  subtitle            String?   @default("Orthopaedic Resuscitation and Trauma Acute Care")
  description         String?   @db.Text

  // Giltighetstid
  validityYears       Int       @default(3)          // Standardgiltighetstid

  // Recertifikationskrav
  recertRequired      Boolean   @default(true)
  recertCourseName    String?   @default("ORTAC Uppdateringskurs")
  recertValidityYears Int       @default(3)

  // LIPUS-referens
  lipusNumber         String?
  lipusValidUntil     DateTime?

  // Designelement
  logoUrl             String?
  signatureImageUrl   String?
  signerName          String?   @default("Kursansvarig")
  signerTitle         String?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([courseId])
}

// ============================================
// LIPUS-UTVÄRDERING
// ============================================

model LipusEvaluation {
  id               String   @id @default(cuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  cohortId         String?
  cohort           Cohort?  @relation(fields: [cohortId], references: [id], onDelete: SetNull)
  overallRating    Int
  wouldRecommend   Boolean?
  responses        Json
  freeTextFeedback String?  @db.Text
  submittedAt      DateTime @default(now())

  @@index([cohortId])
}

// ============================================
// NOTIFIKATIONER
// ============================================

model PushSubscription {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint   String   @unique
  p256dh     String
  auth       String
  userAgent  String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId])
}

model Notification {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String
  title     String
  body      String
  data      Json?
  read      Boolean   @default(false)
  sentAt    DateTime  @default(now())
  readAt    DateTime?

  @@index([userId, read])
  @@index([sentAt])
}

// ============================================
// AUDIT LOGGING
// ============================================

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  ACCESS
  EXPORT
}

model AuditLog {
  id          String      @id @default(cuid())
  userId      String?
  action      AuditAction
  entityType  String
  entityId    String?
  details     Json?
  ipAddress   String?
  userAgent   String?
  timestamp   DateTime    @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([timestamp])
}

// ============================================
// LOGIN ATTEMPTS (for account lockout)
// ============================================

model LoginAttempt {
  id           String   @id @default(cuid())
  identifier   String   // personnummer or IP
  success      Boolean
  ipAddress    String?
  userAgent    String?
  attemptedAt  DateTime @default(now())

  @@index([identifier])
  @@index([attemptedAt])
}

// ============================================
// LÖSENORDSÅTERSTÄLLNING
// ============================================

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
}

// ============================================
// GAMIFICATION
// ============================================

model Badge {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String
  iconUrl     String?
  category    String   // PROGRESS, ACHIEVEMENT, STREAK, SPECIAL
  xpReward    Int      @default(0)
  requirement Json?    // Flexible requirements (e.g., { "chaptersCompleted": 5 })
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  users UserBadge[]

  @@index([category])
  @@index([code])
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badgeId   String
  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  earnedAt  DateTime @default(now())
  notified  Boolean  @default(false)

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
  @@index([earnedAt])
}

// ============================================
// EPA - ENTRUSTABLE PROFESSIONAL ACTIVITIES
// ============================================

model EPA {
  id          String   @id @default(cuid())
  code        String   @unique
  title       String
  description String   @db.Text
  objectives  String[] // Mål för denna EPA
  criteria    String[] // Bedömningskriterier
  sortOrder   Int
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  // Relations
  assessments EPAAssessment[]

  @@index([code])
}

model EPAAssessment {
  id              String   @id @default(cuid())
  epaId           String
  epa             EPA      @relation(fields: [epaId], references: [id], onDelete: Cascade)
  participantId   String
  assessorId      String
  entrustmentLevel Int     // 1-5
  comments        String?  @db.Text
  assessedAt      DateTime @default(now())

  @@index([epaId])
  @@index([participantId])
  @@index([assessorId])
}

// ============================================
// OSCE STATIONER
// ============================================

model OSCEStation {
  id             String   @id @default(cuid())
  code           String   @unique
  title          String
  scenario       String   @db.Text
  checklist      String[] // Checklista-items
  criticalErrors String[] // Kritiska fel (automatiskt underkänt)
  timeLimit      Int      // Minuter
  sortOrder      Int
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())

  @@index([code])
}

// ============================================
// KIRKPATRICK PILOT EVALUATION
// ============================================

enum KirkpatrickLevel {
  REACTION    // Nivå 1: Deltagarnas reaktion
  LEARNING    // Nivå 2: Kunskapsinhämtning
  BEHAVIOR    // Nivå 3: Beteendeförändring
  RESULTS     // Nivå 4: Organisatoriska resultat
}

model PilotAssessment {
  id               String            @id @default(cuid())
  participantId    String
  kirkpatrickLevel KirkpatrickLevel
  assessmentType   String            // Typ av mätning (ex: "satisfaction", "pretest", "posttest", "audit")
  score            Float?
  maxScore         Float?
  responses        Json?             // Detaljerade svar
  notes            String?           @db.Text
  assessedAt       DateTime          @default(now())

  @@index([participantId])
  @@index([kirkpatrickLevel])
  @@index([assessmentType])
}

// ============================================
// INSTRUKTÖRSGUIDER
// ============================================

model InstructorGuide {
  id            String   @id @default(cuid())
  courseId      String?
  type          String   // OSCE_EXAMINER, EPA_ASSESSOR, GENERAL, CHECKLIST
  title         String
  content       String   @db.Text
  version       Int      @default(1)
  sortOrder     Int
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([courseId, type])
  @@index([type])
}

// ============================================
// ORGANISATIONER & ARBETSGIVARPORTAL
// ============================================

enum ReportFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
}

enum OrganizationMemberRole {
  EMPLOYEE
  MANAGER
  ADMIN
}

model Organization {
  id                  String            @id @default(cuid())
  name                String
  organizationNumber  String?           @unique
  contactEmail        String
  contactPhone        String?
  address             String?
  reportFrequency     ReportFrequency   @default(MONTHLY)
  reportEnabled       Boolean           @default(true)
  lastReportSentAt    DateTime?
  nextReportDueAt     DateTime?
  logoUrl             String?
  isActive            Boolean           @default(true)
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  // Relations
  members             OrganizationMember[]
  reportRecipients    OrganizationReportRecipient[]

  @@index([organizationNumber])
  @@index([isActive])
}

model OrganizationMember {
  id              String                  @id @default(cuid())
  organizationId  String
  organization    Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId          String
  user            User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  role            OrganizationMemberRole  @default(EMPLOYEE)
  department      String?
  addedAt         DateTime                @default(now())

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
}

model OrganizationReportRecipient {
  id              String       @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email           String
  name            String?
  isActive        Boolean      @default(true)
  createdAt       DateTime     @default(now())

  @@index([organizationId])
}

// ============================================
// MEDIABIBLIOTEK (Cloudflare R2)
// ============================================

enum MediaType {
  IMAGE
  VIDEO
  PDF
}

model MediaAsset {
  id            String    @id @default(cuid())
  filename      String
  originalName  String
  mimeType      String
  size          Int
  type          MediaType
  r2Key         String    @unique
  r2Bucket      String    @default("ortim-media")
  url           String
  thumbnailUrl  String?
  alt           String?
  caption       String?
  videoProvider String?   // 'youtube', 'vimeo' för inbäddad video
  videoId       String?   // Video-ID från provider
  width         Int?
  height        Int?
  uploadedById  String
  uploadedBy    User      @relation(fields: [uploadedById], references: [id])
  tags          String[]
  usageCount    Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([type])
  @@index([uploadedById])
  @@index([createdAt])
}

// ============================================
// AI & PERSONALISERING
// ============================================

model ChatConversation {
  id        String        @id @default(cuid())
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  messages  ChatMessage[]

  @@index([userId])
  @@index([updatedAt])
}

model ChatMessage {
  id             String           @id @default(cuid())
  conversationId String
  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role           String           // "user" | "assistant"
  content        String           @db.Text
  contextUsed    Json?            // Vilka kapitel/frågor användes som kontext
  tokensUsed     Int?
  createdAt      DateTime         @default(now())

  @@index([conversationId])
  @@index([createdAt])
}

model ContentEmbedding {
  id          String   @id @default(cuid())
  contentType String   // "CHAPTER" | "QUESTION" | "OBJECTIVE"
  contentId   String
  chunkIndex  Int      @default(0)
  content     String   @db.Text
  embedding   Float[]  // Vector som array
  createdAt   DateTime @default(now())

  @@unique([contentType, contentId, chunkIndex])
  @@index([contentType])
}

model UserLearningProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  weakTopics      Json     // Array av topic IDs med låga poäng
  strongTopics    Json     // Array av topic IDs med höga poäng
  preferredTimes  Json?    // Vilka tider användaren studerar
  averageSession  Int?     // Genomsnittlig sessionslängd i minuter
  learningStyle   String?  // "visual" | "reading" | "practice"
  updatedAt       DateTime @updatedAt

  @@index([userId])
}

// ============================================
// AVANCERAD ANALYTICS (Fas 11)
// ============================================

// Sessionsspårning för korrekt mätning av studietid
model UserSession {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  startedAt       DateTime  @default(now())
  endedAt         DateTime?
  durationSeconds Int?
  pageViews       Int       @default(0)
  actions         Int       @default(0)
  deviceType      String?   // "mobile", "tablet", "desktop"
  browser         String?
  isActive        Boolean   @default(true)

  @@index([userId, startedAt])
  @@index([isActive])
}

// Sparade rapporter för instruktörer
model SavedReport {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name          String
  description   String?
  reportType    String    // "cohort", "question", "progress", "custom"
  configuration Json      // Rapportparametrar
  schedule      String?   // Cron för schemalagda rapporter
  lastRunAt     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([userId])
  @@index([reportType])
}

// Prediktioner för riskidentifiering
model UserPrediction {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  predictionType String   // "dropout_risk", "exam_score", "completion_date"
  value          Float    // Predikterat värde (0-100 för risk, poäng, eller dagar)
  confidence     Float    // Konfidensgrad (0-1)
  factors        Json     // Bidragande faktorer
  generatedAt    DateTime @default(now())

  @@index([userId, predictionType])
  @@index([generatedAt])
}

// Custom event tracking för granulär spårning
model AnalyticsEvent {
  id         String   @id @default(cuid())
  userId     String?
  sessionId  String?
  eventType  String   // "click", "scroll", "video_play", "search", "quiz_start"
  eventName  String   // Specifikt händelsenamn
  properties Json?    // Händelsespecifik data
  pageUrl    String?
  referrer   String?
  timestamp  DateTime @default(now())

  @@index([eventType, timestamp])
  @@index([userId, timestamp])
  @@index([eventName])
  @@index([sessionId])
}

// ============================================
// FAS 13: A/B-TESTNING
// ============================================

enum ABTestStatus {
  DRAFT
  RUNNING
  PAUSED
  COMPLETED
}

model ABTest {
  id          String       @id @default(cuid())
  name        String
  description String?      @db.Text
  status      ABTestStatus @default(DRAFT)

  // Test configuration
  testType    String       // "content", "ui", "quiz", "algorithm"
  targetPage  String?      // Vilken sida/komponent som testas

  // Traffic allocation
  trafficPercent Int       @default(100) // Andel av trafik som ingår i testet

  // Goals and metrics
  primaryMetric  String    // "completion_rate", "quiz_score", "time_on_page", "click_rate"
  secondaryMetrics Json?   // Array av sekundära mätvärden

  // Dates
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  createdById String?

  // Relations
  variants    ABTestVariant[]
  assignments ABTestAssignment[]
  conversions ABTestConversion[]

  @@index([status])
  @@index([testType])
  @@index([startDate, endDate])
}

model ABTestVariant {
  id          String   @id @default(cuid())
  testId      String
  test        ABTest   @relation(fields: [testId], references: [id], onDelete: Cascade)

  name        String   // "Control", "Variant A", "Variant B"
  description String?
  isControl   Boolean  @default(false) // Markera kontrollgruppen

  // Configuration
  config      Json     // Variantspecifik konfiguration
  weight      Int      @default(50) // Viktning för fördelning (summan ska vara 100)

  // Aggregated stats (uppdateras periodiskt)
  impressions Int      @default(0)
  conversions Int      @default(0)

  // Relations
  assignments ABTestAssignment[]
  conversionRecords ABTestConversion[]

  @@index([testId])
}

model ABTestAssignment {
  id        String   @id @default(cuid())
  testId    String
  test      ABTest   @relation(fields: [testId], references: [id], onDelete: Cascade)
  variantId String
  variant   ABTestVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  // User identification (can be userId or sessionId for anonymous)
  userId    String?
  sessionId String?

  assignedAt DateTime @default(now())

  @@unique([testId, userId])
  @@unique([testId, sessionId])
  @@index([testId, variantId])
  @@index([userId])
  @@index([sessionId])
}

model ABTestConversion {
  id        String   @id @default(cuid())
  testId    String
  test      ABTest   @relation(fields: [testId], references: [id], onDelete: Cascade)
  variantId String
  variant   ABTestVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  userId    String?
  sessionId String?

  // Conversion data
  metricName  String   // Vilket mätvärde
  metricValue Float    // Värdet (t.ex. poäng, tid i sekunder)

  convertedAt DateTime @default(now())

  @@index([testId, variantId])
  @@index([metricName])
  @@index([convertedAt])
}
